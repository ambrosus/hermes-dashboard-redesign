/* Ambrosus Javascript SDK v2.0.4 */(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b(require('web3')):'function'==typeof define&&define.amd?define(['web3'],b):(a=a||self,a.AmbrosusSDK=b(a.Web3))})(this,function(a){'use strict';function b(a,b,c){return new Promise((d,f)=>{let g=new XMLHttpRequest;if(g.open('GET',`${a}${r.serializeParams(c)}`,!0),b)for(const a in b)g.setRequestHeader(`${a}`,`${b[a]}`);g.onload=()=>{e(g).then(a=>d(a)).catch(a=>f(a))},g.send()})}function c(a,b,c){return new Promise((d,f)=>{let g=new XMLHttpRequest;if(g.open('POST',a,!0),g.setRequestHeader('Content-type','application/json; charset=utf-8'),b)for(const a in b)g.setRequestHeader(`${a}`,`${b[a]}`);g.onload=()=>{e(g).then(a=>d(a)).catch(a=>f(a))},g.send(JSON.stringify(c))})}var d=Math.floor;a=a&&Object.prototype.hasOwnProperty.call(a,'default')?a['default']:a;const e=a=>new Promise((b,c)=>{const d={status:a.status,data:null,message:JSON.parse(a.response).reason};(200===a.status||201===a.status)&&(d.data=JSON.parse(a.response),d.message='success',b(d)),c(d)}),f=a=>({status:400,data:null,message:a}),g=a=>({status:200,data:a,message:'success'}),h=new a,i=a=>h.eth.accounts.hashMessage(a),j=a=>{if((a=>'object'==typeof a&&!Array.isArray(a))(a)){const b=Object.keys(a).sort().map(b=>`"${b}":${j(a[b])}`).join(',');return`{${b}}`}if((a=>Array.isArray(a))(a)){const b=a.map(a=>j(a)).join(',');return`[${b}]`}return(a=>'string'==typeof a)(a)?`"${a}"`:a.toString()},k=require('fs'),l=require('path'),m=a=>{try{let b=d((+new Date-a)/1e3),c=d(b/31536e3);return 1<=c?c+' year'+(1<c?'s':''):(c=d(b/2592e3),1<=c)?c+' month'+(1<c?'s':''):(c=d(b/86400),1<=c)?c+' day'+(1<c?'s':''):(c=d(b/3600),1<=c)?c+' hour'+(1<c?'s':''):(c=d(b/60),1<=c)?c+' minute'+(1<c?'s':''):(b=1>b?1:b,d(b)+' second'+(1===b?'':'s'))}catch(a){return''}},n=a=>0<new Date(a).getTime(),o=(c,a)=>c.timestamp>a.timestamp?-1:c.timestamp<a.timestamp?1:0,p=a=>-1===['info','redirection','identifiers','branding','location'].indexOf(a),q=a=>{var b=String.fromCharCode;a=a.replace(/\r\n/g,'\n');let d='';for(let e,c=0;c<a.length;c++)e=a.charCodeAt(c),128>e?d+=b(e):127<e&&2048>e?(d+=b(192|e>>6),d+=b(128|63&e)):(d+=b(224|e>>12),d+=b(128|63&e>>6),d+=b(128|63&e));return d};var r={isObject:function(a){return null!==a&&'object'==typeof a&&a instanceof Object&&!(a instanceof Array)},validTimestamp:n,checkTimeStamp:a=>{let b=d(Date.now()/1e3);return a.content&&a.content.idData&&a.content.idData.timestamp&&n(a.content.idData.timestamp)?a.content.idData.timestamp:b},parseEvents:a=>a.results.reduce((a,{content:b,eventId:c})=>{const d=b.idData.timestamp,e=b.idData.createdBy;return b&&b.data&&b.data.filter(a=>{const f=a.type.split('.'),g=f[f.length-1],h=f[f.length-2]||'asset';return a.timestamp=d,a.author=e,a.name=a.name||g,a.action=g,a.type=g,a.eventId=c,('location'===a.type||'identifiers'===a.type)&&'event'===h?void b.data.reduce((b,c)=>('location'===a.type&&'location'!==c.type&&(c.location=b),'identifiers'===a.type&&'identifiers'!==c.type&&(c.identifiers=b),b),a):a}).map(b=>{-1<['info','redirection','identifiers','branding'].indexOf(b.type)?(!a[b.type]||a[b.type].timestamp<b.timestamp)&&(a[b.type]=b):a.events.push(b)}),a},{events:[]}),serializeParams:a=>{let b='';for(let c in a)''!=b&&(b+='&'),b+=c+'='+encodeURIComponent(a[c]);return b},utf8Encode:q,base64url:a=>{const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';let c,d,e,f,g,h,j,k='',l=0;for(a=q(a);l<a.length;)c=a.charCodeAt(l++),d=a.charCodeAt(l++),e=a.charCodeAt(l++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,j=63&e,isNaN(d)?h=j=64:isNaN(e)&&(j=64),k=k+b.charAt(f)+b.charAt(g)+b.charAt(h)+b.charAt(j);return k},checkAccessLevel:a=>{try{return a.content.idData.accessLevel}catch(a){return 0}},getImage:a=>{try{return a.images.default.url}catch(a){return''}},getLocation:a=>{const b=a.location||a,{city:c,country:d,name:e}=b;return[c,d,e].filter(a=>!!a).join(', ')||'No place attached'},getName:(a,b='No title')=>{try{const b=a.name;let c=a.type.split('.');return c=c[c.length-1],[b,c].find(a=>a)}catch(a){return b}},getUrlName:a=>{let b=a.split('/');return b=b[b.length-1],b},sortEventsByTimestamp:o,parseAsset:a=>{a.info||(a.info={}),a.info.groups=[],a.info.properties=[],Object.keys(a.info).map(b=>{if('location'===b||'identifiers'===b)a[b]=a.info[b];else if(-1===['type','name','assetType','images','eventId','createdBy','timestamp','groups','properties'].indexOf(b)){const c={key:b,value:a.info[b]};a.info['string'==typeof c.value||Array.isArray(c.value)?'properties':'groups'].push(c)}})},parseEvent:a=>(a.info={},a.info.groups=[],a.info.properties=[],a.content.data&&Array.isArray(a.content.data)&&a.content.data.map(b=>{const c=b.type.split('.');return b.type=c[c.length-1].toLowerCase(),'location'===b.type||'identifiers'===b.type?a.info[b.type]=b:(a.info.name=b.name||b.type,Object.keys(b).map(c=>{if(-1<['images','documents','description'].indexOf(c)&&(a.info[c]=b[c]),-1===['type','name','assetType','eventId','createdBy','timestamp','location','images','documents','description','identifiers','groups','properties'].indexOf(c)){const d={key:c,value:b[c]};a.info['string'==typeof d.value||Array.isArray(d.value)?'properties':'groups'].push(d)}})),b}),a),isLatest:p,findEvent:(a,b)=>{let c=!1;return b.map(b=>(b.content.data&&b.content.data.map(d=>{const e=d.type.split('.');return d.type=e[e.length-1],d.type=d.type.toLowerCase(),('location'===d.type||'identifiers'===d.type)&&b.content.data.map(a=>{-1===['location','identifiers'].indexOf(a.type)&&(a['location'===d.type?'location':'identifiers']=d)}),('latest'===a?p(d.type)&&(c=d):d.type===a&&(c=d),d)}),b)),c},parseTimelineEvents:a=>{const b=a.reduce((a,{content:b,eventId:c})=>{const d=b.idData.timestamp,e=b.idData.createdBy;return b&&b.data&&b.data.map(f=>{const g=f.type.split('.'),h=g[g.length-1],i=g[g.length-2]||'asset',j=m(1e3*d);f.timestamp=d,f.createdBy=e,f.name=f.name||h,f.type=h,f.eventId=c,f.ago=j,'location'===f.type&&'event'===i&&b.data.reduce((a,b)=>{'location'!==b.type&&(b.location=a)},f);return-1===['location','identifier','identifiers'].indexOf(f.type)&&a.push(f),f}),a},[]);return b.sort(o),b},timeSince:m,isAddress:a=>h.utils.isAddress(a),fromWei:(a,b='ether')=>h.utils.fromWei(a,b),toWei:(a,b='ether')=>h.utils.toWei(a,b),toHex:a=>h.utils.toHex(a),randomHex:a=>h.utils.randomHex(a),hashMessage:i,calculateHash:a=>a?i(j(a)):f('Please provide some data'),serializeForHashing:j,readFile:a=>new Promise((b,c)=>{k.readFile(a,'utf8',(a,d)=>{a?c(a):b(d)})})};class s{constructor(){this.events={},this.empty=[]}on(a,b,c){return(this.events[a]=this.events[a]||[]).push([b,c]),this}off(a,b){a||(this.events={});let c=this.events[a]||this.empty,d=c.length=b?c.length:0;for(;d--;)b===c[d][0]&&c.splice(d,1);return this}emit(a){let b,c=this.events[a]||this.empty,d=0<c.length?c.slice(0,c.length):c,e=0;for(;b=d[e++];)b[0].apply(b[1],this.empty.slice.call(arguments,1));return this}}class t{constructor(a,b){this._settings=a,this.service=b,this.eventHandler=new s}getAssetEvents(a){return new Promise((c,d)=>a?void b(`${this._settings.apiEndpoint}/event2/list/?assteId=${encodeURIComponent(a)}`,this._settings.headers).then(a=>c(a)).catch(a=>d(a)):d(f('Asset ID is missing.')))}getEvents(a){return new Promise((c,d)=>{b(`${this._settings.apiEndpoint}/event2/list?${r.serializeParams(a)}`,this._settings.headers).then(a=>c(a)).catch(a=>d(a))})}createSingleEvent(a,b,d){return console.log(`createSingleEvent.eventId: ${b}`),new Promise((a,e)=>{c(`${this._settings.apiEndpoint}/event2/create/${b}`,this._settings.headers,d).then(b=>a(b)).catch(a=>e(a))})}createEvent(a,b){return new Promise((c,d)=>{if('object'!=typeof b)return d(f('event should be a json object'));if(!this._settings.headers.Authorization)return d(f('Authorization header is required to create an event'));if(!a)return d(f('Asset ID is missing.'));if(!b)return d(f('Event data is missing.'));let e={};if(b.content&&b.content.data){const c={assetId:a,timestamp:r.checkTimeStamp(b),accessLevel:r.checkAccessLevel(b),createdBy:this._settings.address,dataHash:r.calculateHash(b.content.data)};e={content:{idData:c,signature:this.service.sign(c,this._settings.secret),data:b.content.data}}}else return d(f('Invalid data: No content found at content.data.'));let g=r.calculateHash(e.content);return this.createSingleEvent(a,g,e).then(a=>{this.eventHandler.emit('event:created'),c(a)}).catch(a=>d(a))})}parseEvents(a){return new Promise((b,c)=>a&&a.results?b(g(r.parseEvents(a))):c(f('Results array is missing.')))}}class u{constructor(a,b){this._settings=a,this.service=b,this.events=new t(this._settings,this.service),this.eventHandler=new s}getAsset(a){return new Promise((c,d)=>a?void(a.assetId&&(a=a.assetId),b(`${this._settings.apiEndpoint}/asset2/info/${encodeURIComponent(a)}`,this._settings.headers).then(a=>c(a)).catch(a=>d(a))):d(f('Asset ID is missing.')))}getAssets(a={}){return new Promise((c,d)=>{b(`${this._settings.apiEndpoint}/asset2/list?${r.serializeParams(a)}`,this._settings.headers).then(a=>c(a)).catch(a=>d(a))})}createAsset(a={},b=[]){let d=0;return new Promise((e,g)=>{if('object'!=typeof a)return g(f('asset should be a json object or empty'));if(!this._settings.headers.Authorization)return g(f('Authorization header is required to create an asset'));const h={timestamp:r.checkTimeStamp(a),sequenceNumber:d=(d+1)%1e6,createdBy:this._settings.address},i={content:{idData:h,signature:this.service.sign(h,this._settings.secret)}};let j=r.calculateHash(i.content);c(`${this._settings.apiEndpoint}/asset2/create/${j}`,this._settings.headers,i).then(async a=>{if(b.length){const c=b.map(b=>this.events.createEvent(a.data.assetId,b));await Promise.all(c),this.eventHandler.emit('asset:created'),e(a)}else this.eventHandler.emit('asset:created'),e(a)}).catch(a=>g(a))})}}class v{constructor(a){this._settings=a}addAccount(a){return new Promise((b,d)=>{if(!this._settings.headers.Authorization)return d(f('Authorization header is required to create an account'));return a?void c(`${this._settings.apiEndpoint}/accounts`,this._settings.headers,a).then(a=>b(a)).catch(a=>d(a)):d(f('Create account params are required to create an account.'))})}}class w{constructor(a){this._settings=a}getBundle(a){return new Promise((c,d)=>a?void(a.bundleId&&(a=a.bundleId),b(`${this._settings.apiEndpoint}/bundle2/info/${encodeURIComponent(a)}`,this._settings.headers).then(a=>c(a)).catch(a=>d(a))):d(f('Bundle ID is missing.')))}}class x{constructor(a,b,c){this._settings=a,this.web3=c,this.service=b}getBalance(a=null){return new Promise((b,c)=>{const d=a||this._settings.address;return this._settings.rpcURL?d?void this.web3.eth.getBalance(d).then(a=>b(a)).catch(a=>c(a)):c(f('Address is required to get the balance')):c(f('RPC URL is required to get the balance'))})}getTransaction(a){return new Promise((b,c)=>this._settings.rpcURL?a?this.web3.eth.getTransaction(a).then(a=>b(a)).catch(a=>c(a)):c(f('Transaction hash is required')):c(f('RPC URL is required')))}getTransactionRecepit(a){return new Promise((b,c)=>this._settings.rpcURL?a?this.web3.eth.getTransactionReceipt(a).then(a=>b(a)).catch(a=>c(a)):c(f('Transaction hash is required')):c(f('RPC URL is required')))}getTransactionCount(a=null){return new Promise((b,c)=>{const d=a||this._settings.address;return this._settings.rpcURL?d?this.web3.eth.getTransactionCount(d).then(a=>b(a)).catch(a=>c(a)):c(f('Address is required to get the transaction count')):c(f('RPC URL is required'))})}sendTransaction(a,b,c=null){return new Promise((d,e)=>{if(!this._settings.secret&&!this._settings.rpcURL)return e(f('Secret key and RPC URL is required to make a transaction'));const g={to:a,from:this._settings.address,value:this.web3.utils.toHex(this.web3.utils.toWei(b,'ether')),gas:this.web3.utils.toHex(21e3),gasPrice:this.web3.utils.toHex(this.web3.utils.toWei('10','gwei'))};c&&(g.data=c);const h=this.service.getAccount(this._settings.secret),i=h.signTransaction(g);i.then(a=>{this.web3.eth.sendSignedTransaction(a.rawTransaction).then(a=>d(a)).catch(a=>e(a))}).catch(a=>{e(a)})})}}class y{constructor(a,b,c){this._settings=a,this.web3=b,this.events=c,this.events=new t(this._settings)}getAccount(a=null){const b=a||this._settings.secret;return b?this.web3.eth.accounts.privateKeyToAccount(b):f('Secret key is required generate the account')}getAddress(a=null){const b=a||this._settings.secret;return b?this.web3.eth.accounts.privateKeyToAccount(b).address:f('Secret key is required generate the address')}sign(a={},b=null){const c=b||this._settings.secret;return c?this.web3.eth.accounts.sign(r.serializeForHashing(a),c).signature:f('Secret key is required to perform signature')}getPkPair(){return this.web3.eth.accounts.create(this.web3.utils.randomHex(32))}encryptPrivateKey(a,b=null){const c=b||this._settings.secret;if(!c)return f('Secret key is required generate a signature');return a?this.web3.eth.accounts.encrypt(c,a):f('Token is required to encrypt the data')}decryptPrivateKey(a,b){try{const{address:c,privateKey:d}=this.web3.eth.accounts.decrypt(a,b);return[c,d]}catch(a){return[null]}}verifyEvents(a){return new Promise((b,c)=>a?void this.events.getAssetEvents(a).then(c=>{console.log(`verifyEvents: assetId ${a}, events ${c.data.data.length}`);for(let a=0;a<c.data.data.length;a++){const{idData:d,signature:e,data:f}=c.data.data[a].content;b(this.verify(d,e,f,c.data.data[a].eventId))}}).catch(a=>{c(a)}):c(f('Asset ID is required')))}verify(a,b,c,d){let e=!0;const f=r.calculateHash(c);a.dataHash!==f&&(e=!1,verifyObject.hash=!1);const g=this.web3.eth.accounts.recover(r.serializeForHashing(a),b);a.createdBy!==g&&(e=!1,verifyObject.createdBy=!1);const h=r.calculateHash({idData:a,data:c,signature:b});return d!==h&&(e=!1,verifyObject.eventId=!1),{flag:e,verified:{hash:!0,createdBy:!0,eventId:!0}}}isRPCValid(b){const c=new a(b);return c.eth.net.isListening().then(()=>!0).catch(()=>!1)}}class z{constructor(a,b){this._settings=a,this.web3=b}getBlock(a){return new Promise((b,c)=>this._settings.rpcURL?a?this.web3.eth.getBlock(a).then(a=>b(a)).catch(a=>c(a)):c(f('Block Number is required')):c(f('RPC URL is required')))}getLatestBlock(){return new Promise((a,b)=>this._settings.rpcURL?void this.web3.eth.getBlockNumber().then(c=>this.web3.eth.getBlock(c).then(b=>a(b)).catch(a=>b(a))).catch(a=>b(a)):b(f('RPC URL is required')))}}class A{constructor(a,b){this._settings=a,this.web3=b}loadContract(a,b){return this._settings.rpcURL?this.web3.eth.Contract(a,b,{gas:47e5,gasPrice:this.web3.utils.toWei('5','gwei')}):f('RPC URL is required')}}class B{static get utils(){return r}constructor(b={}){if(this.web3=new a,this._settings={headers:{}},r.isObject(b)){if(Object.keys(b).map(a=>{this._settings[a]=b[a]}),this._settings.rpcURL&&(this.web3=new a(new a.providers.HttpProvider(this._settings.rpcURL))),this.service=new y(this._settings,this.web3),this._settings.secret){this._settings.address=this.service.getAddress(this._settings.secret);const a=this.getApiToken(this._settings.secret);400!==a.status&&(this._settings.token=a)}this._settings.headers&&this._settings.headers.Authorization||!this._settings.token||(this._settings.headers=Object.assign({},this._settings.headers,{Authorization:`AMB_TOKEN ${this._settings.token}`})),this.service=new y(this._settings,this.web3),this.assets=new u(this._settings,this.service),this.events=new t(this._settings,this.service),this.bundles=new w(this._settings),this.accounts=new v(this._settings),this.contracts=new A(this._settings,this.web3),this.transactions=new x(this._settings,this.service,this.web3),this.blocks=new z(this._settings,this.web3),this.utils=r}else return f('SDK Init parameters should be an object')}getApiToken(a=null,b){if(!a&&!this._settings.secret)return f('Secret key is required generate the token');const c=a||this._settings.secret,e={createdBy:this.service.getAddress(c),validUntil:b||d(Date.now()/1e3)+300};return r.base64url(r.serializeForHashing({signature:this.service.sign(e,c),idData:e}))}}return B});
//# sourceMappingURL=ambrosus.umd.min.js.map
